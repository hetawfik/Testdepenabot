name: Auto-fix Dependabot alerts (Multi-ecosystem)

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      severity:
        description: 'Severity filter'
        required: false
        default: 'high,critical'
        type: choice
        options:
          - 'low,medium,high,critical'
          - 'medium,high,critical'
          - 'high,critical'
          - 'critical'
      ecosystem:
        description: 'Ecosystem (leave empty for auto-detect)'
        required: false
        type: choice
        options:
          - ''
          - 'npm'
          - 'maven'
          - 'python'

permissions:
  contents: write
  pull-requests: write
  security-events: read

jobs:
  fix-vulnerabilities:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEP_PAT }}
          
      - name: Detect project type
        id: detect
        run: |
          ECOSYSTEM="${{ inputs.ecosystem }}"
          
          if [ -z "$ECOSYSTEM" ]; then
            if [ -f "package.json" ]; then
              ECOSYSTEM="npm"
            elif [ -f "pom.xml" ]; then
              ECOSYSTEM="maven"
            elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
              ECOSYSTEM="python"
            fi
          fi
          
          echo "type=$ECOSYSTEM" >> $GITHUB_OUTPUT
          echo "Detected ecosystem: $ECOSYSTEM"
          
      - name: Get Dependabot alerts
        id: alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEP_PAT }}
          script: |
            const severity = '${{ inputs.severity || 'high,critical' }}';
            const ecosystem = '${{ steps.detect.outputs.type }}';
            
            console.log(`Fetching alerts with severity: ${severity}, ecosystem: ${ecosystem}`);
            
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              severity: severity
            });
            
            console.log(`Total alerts found: ${alerts.data.length}`);
            
            const ecosystemMap = {
              'npm': 'npm',
              'maven': 'maven',
              'python': 'pip'
            };
            
            const targetEcosystem = ecosystemMap[ecosystem];
            
            const vulnerabilities = alerts.data
              .filter(alert => {
                if (!alert.security_vulnerability?.package?.ecosystem) return false;
                if (alert.security_vulnerability.package.ecosystem !== targetEcosystem) return false;
                if (!alert.security_vulnerability.first_patched_version) return false;
                return true;
              })
              .map(alert => ({
                alertNumber: alert.number,
                package: alert.security_vulnerability.package.name,
                currentVersion: alert.security_vulnerability.vulnerable_version_range,
                fixedVersion: alert.security_vulnerability.first_patched_version.identifier,
                severity: alert.security_advisory.severity,
                summary: alert.security_advisory.summary
              }));
            
            console.log(`Fixable vulnerabilities: ${vulnerabilities.length}`);
            core.setOutput('vulnerabilities', JSON.stringify(vulnerabilities));
            core.setOutput('count', vulnerabilities.length.toString());
            
      - name: Check if vulnerabilities found
        if: steps.alerts.outputs.count == '0'
        run: |
          echo "No fixable vulnerabilities found for ${{ steps.detect.outputs.type }}"
          exit 0
          
      # NPM Updates
      - name: Setup Node.js
        if: steps.detect.outputs.type == 'npm' && steps.alerts.outputs.count > 0
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update npm packagesc
        if: steps.detect.outputs.type == 'npm' && steps.alerts.outputs.count > 0
        run: |
          echo '${{ steps.alerts.outputs.vulnerabilities }}' | jq -r '.[] | "\(.package)@\(.fixedVersion)"' | while read package_version; do
            echo "Installing $package_version..."
            npm install "$package_version" --save
           done
        
      - name: Run npm tests
        if: steps.detect.outputs.type == 'npm' && steps.alerts.outputs.count > 0
        run: |
          npm ci
          npm run build
          npm test
          
      # Maven Updates
      - name: Setup Java
        if: steps.detect.outputs.type == 'maven' && steps.alerts.outputs.count > 0
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Update Maven dependencies
        if: steps.detect.outputs.type == 'maven' && steps.alerts.outputs.count > 0
        run: |
          echo '${{ steps.alerts.outputs.vulnerabilities }}' | jq -r '.[] | "\(.package):\(.fixedVersion)"' | while IFS=: read package version; do
            echo "Updating $package to $version..."
            GROUP_ID=$(echo "$package" | cut -d: -f1)
            ARTIFACT_ID=$(echo "$package" | cut -d: -f2)
            
            mvn versions:use-dep-version \
              -Dincludes="${GROUP_ID}:${ARTIFACT_ID}" \
              -DdepVersion="$version" \
              -DforceVersion=true
          done
          
          mvn versions:commit
          
      - name: Run Maven tests
        if: steps.detect.outputs.type == 'maven' && steps.alerts.outputs.count > 0
        run: mvn clean verify
          
      # Python Updates
      - name: Setup Python
        if: steps.detect.outputs.type == 'python' && steps.alerts.outputs.count > 0
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Update Python packages
        if: steps.detect.outputs.type == 'python' && steps.alerts.outputs.count > 0
        run: |
          echo '${{ steps.alerts.outputs.vulnerabilities }}' | jq -r '.[] | "\(.package)==\(.fixedVersion)"' | while read package_version; do
            echo "Updating $package_version..."
            PACKAGE=$(echo "$package_version" | cut -d= -f1)
            VERSION=$(echo "$package_version" | cut -d= -f3)
            
            if [ -f "requirements.txt" ]; then
              sed -i "s/^${PACKAGE}==.*/${PACKAGE}==${VERSION}/" requirements.txt
              pip install -r requirements.txt
            elif [ -f "pyproject.toml" ]; then
              pip install "$package_version"
            fi
          done
          
      - name: Run Python tests
        if: steps.detect.outputs.type == 'python' && steps.alerts.outputs.count > 0
        run: |
          if [ -f "pytest.ini" ]; then
            pip install pytest
            pytest
          fi
          
      # Create PR
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DEPENDABOT_PAT }}
          commit-message: 'security: fix ${{ steps.detect.outputs.type }} Dependabot vulnerabilities'
          branch: security/dependabot-fixes-${{ github.run_number }}
          delete-branch: true
          title: 'ðŸ”’ Security: Fix ${{ steps.detect.outputs.type }} vulnerabilities'
          body: |
            ## Fixed Vulnerabilities
            
            ${{ steps.alerts.outputs.vulnerabilities }}
            
            âœ… Tests passed
            
            Please review and merge manually.
          labels: security, dependabot, ${{ steps.detect.outputs.type }}
